<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<!--
`uvalib-events-card`
This card component generates the LibCal mini calendar widget which allows for selecting a single calendar and filtering on library as well as category.

### Styling

The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--uvalib-events-card-bkgrd-color` | Background color of card | `Based on uvalib-theme --color-text-gray`
`--uvalib-events-card-header-color` | Color of card header text | `Based on uvalib-theme --color-white`

Note: Consult the styling used in the actual Springshare Events Calendar for widget output for a single color for the component and iframe content.

@demo demo/index.html
-->

<dom-module id="uvalib-events-card">
  <template>
    <style is="custom-style">
      :host {
        display: block;
        --uvalib-events-card-header-font-size: 24px;
        --uvalib-events-card-header-font-weight: bold;
        background-color: var(--uvalib-events-card-bkgrd-color,--color-light-gray);
        padding: var(--uvalib-events-card-padding,15px);
        --iron-icon-fill-color: var(--color-text-gray,black);
      }
      iron-icon {
        padding-right: 10px;
      }
      .card-header {
        font-size: var(--uvalib-events-card-header-font-size,--header-font-size);
        font-weight: var(--uvalib-events-card-header-font-weight,--font-weight-demi);
        padding-bottom: 20px;
      }
      .card-actions {
        border-top: 1px solid gray;
      }
      .s-lc-ea-h3 {
        display: none;
      }
      ul {
          list-style-type: none;
          margin: 0;
          padding: 0;
          overflow: hidden;
      }
      li a {
        text-decoration: none;
        color: black;
      }
      .s-lc-ea-date {
        font-size: 12px;
      }
    </style>

    <div class="card">
      <div class="card-header">
        <iron-icon icon$="{{headingIcon}}"></iron-icon> {{heading}}
      </div>
      <div class="card-content">
        <div id$="api_upc_cid{{calId}}_iid{{institutionId}}" class="container"></div>
        <script type="text/javascript" src$="{{_widgetUrlWithParams}}">
        </script>
      </div>
      <div class="card-actions">
        <content></content>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'uvalib-events-card',

      properties: {
        headingIcon: {
          type: String,
          value: "calendar"
        },
        /**
         * Card heading to use for the uvalib-events-card component.
         */
        heading: {
          type: String,
          value: ""
        },

        /**
         * Identifier for the LibCal account id. Defaults to existing UVA Library account having ID 863.
         */
        institutionId: {
          type: String,
          value: 863
        },

        /**
         * Identifier for the LibCal calender to display. Defaults to existing UVA Library Events calendar having ID 4299.
         */
        calId: {
          type: String,
          value: 4299
        },

        /**
         * Identifier(s) for the LibCal locations to limit what displays on the calendar.
         * Use spaces between IDs when specifying multiple values. No value will show all by default.
         */
        locIdsFilter: {
          type: String,
          value: ""
        },

        /**
         * Identifier(s) for the LibCal calendar categories to limit what displays on the calendar.
         * Use spaces between IDs when specifying multiple values. No value will show all by default.
         */
        catIdsFilter: {
          type: String,
          value: ""
        },

        /**
         * Limit the number of events to show.
         */
        maxNumEventsShown: {
          type: Number,
          value: 5
        },

        /**
         * Springshare LibCal API calendar widget script URL.
         */
        _springshareLibCalWidgetUrl: {
          type: String,
          value: "https://api3.libcal.com/api_events.php?m=upc&simple=ul_date&context=object&format=js"
        },

        /**
         * The computed source URL that Springshare is expecting.
         */
        _widgetUrlWithParams: {
          type: String,
          computed: '_generateWidgetUrl(institutionId,calId,locIdsFilter,catIdsFilter,maxNumEventsShown,_springshareLibCalWidgetUrl)'
        }
      },

      /**
       * Create the appropriate URL string that includes the parameters to
       * customize what the calendar widget displays.
       */
      _generateWidgetUrl: function(institutionId,calId,locIdsFilter,catIdsFilter,maxNumEventsShown,_springshareLibCalWidgetUrl) {
        // An institution ID is must be specified.
        // A calendar ID is required and must be in the parameters.
        var params = {
          iid: institutionId,
          cid: calId,
          l: maxNumEventsShown,
          c: locIdsFilter.split(/[ ]+/).join('-'),
          d: catIdsFilter.split(/[ ]+/).join('-')
        }

        var paramStr = "";
        for (var key in params) {
          if (params.hasOwnProperty(key)) {
            paramStr += "&" + key + "=" + params[key];
          }
        }
        return _springshareLibCalWidgetUrl + paramStr;
      },

      /**
       * Apply styles from this component onto the LibCal widget
       */
      ready: function() {
        this.scopeSubtree(this.querySelector('.container'), true);
      }

    });
  </script>
</dom-module>
